<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Alex - Attar Travel Assistant (LiveKit)</title>
  <script src="https://unpkg.com/livekit-client/dist/livekit-client.umd.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      padding: 40px;
      max-width: 600px;
      width: 100%;
      text-align: center;
    }

    h1 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 32px;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 16px;
    }

    .status {
      padding: 15px;
      border-radius: 10px;
      margin: 20px 0;
      font-weight: 500;
    }

    .status.disconnected {
      background: #fee;
      color: #c33;
    }

    .status.connecting {
      background: #ffeaa7;
      color: #d63031;
    }

    .status.connected {
      background: #55efc4;
      color: #00b894;
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 15px 40px;
      border-radius: 50px;
      font-size: 18px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      margin: 10px;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .controls {
      margin-top: 30px;
    }

    .audio-container {
      margin-top: 20px;
    }

    .transcript {
      background: #f5f5f5;
      border-radius: 10px;
      padding: 20px;
      margin-top: 20px;
      max-height: 300px;
      overflow-y: auto;
      text-align: left;
    }

    .transcript-item {
      margin-bottom: 15px;
      padding: 10px;
      border-radius: 8px;
    }

    .transcript-item.agent {
      background: #e3f2fd;
      border-left: 4px solid #667eea;
    }

    .transcript-item.user {
      background: #f3e5f5;
      border-left: 4px solid #764ba2;
    }

    .transcript-label {
      font-weight: bold;
      margin-bottom: 5px;
      font-size: 12px;
      text-transform: uppercase;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .room-info {
      background: #f0f0f0;
      padding: 10px;
      border-radius: 8px;
      margin-top: 15px;
      font-size: 14px;
      color: #666;
    }

    .visualizer {
      width: 100%;
      height: 60px;
      background: #f5f5f5;
      border-radius: 10px;
      margin: 20px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }

    .bar {
      width: 4px;
      height: 20px;
      background: #667eea;
      border-radius: 2px;
      transition: height 0.1s;
    }

    .bar.active {
      animation: pulse 0.5s ease-in-out infinite alternate;
    }

    @keyframes pulse {
      from { height: 20px; }
      to { height: 50px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéôÔ∏è Alex - Travel Assistant</h1>
    <p class="subtitle">Real-time Voice AI powered by LiveKit</p>

    <div id="status" class="status disconnected">
      ‚ö´ Disconnected
    </div>

    <div class="visualizer" id="visualizer">
      <div class="bar"></div>
      <div class="bar"></div>
      <div class="bar"></div>
      <div class="bar"></div>
      <div class="bar"></div>
      <div class="bar"></div>
      <div class="bar"></div>
      <div class="bar"></div>
    </div>

    <div class="controls">
      <button id="connectBtn" onclick="connect()">
        üöÄ Start Conversation
      </button>
      <button id="disconnectBtn" onclick="disconnect()" disabled>
        ‚õî End Call
      </button>
    </div>

    <div class="room-info" id="roomInfo">
      <strong>Room:</strong> <span id="roomName">-</span><br>
      <strong>Agent Status:</strong> <span id="agentStatus">-</span>
    </div>

    <div class="transcript" id="transcript">
      <div style="text-align: center; color: #999;">
        Conversation transcript will appear here...
      </div>
    </div>

    <audio id="audioOutput" autoplay></audio>
  </div>

  <script>
    const LivekitClient = window.LivekitClient

    // LiveKit Configuration
    const LIVEKIT_URL = 'wss://aiinterviewprod-anr5bvh0.livekit.cloud'
    const LIVEKIT_API_KEY = 'APIiwNSMd2Nsxvq'
    const LIVEKIT_API_SECRET = 'KWkVh4Z01q4Sbx9xJegB1fE7iyGijslBNCvogi1Igpb'

    let room = null
    let localTrack = null
    const transcript = []

    // UI Elements
    const statusEl = document.getElementById('status')
    const connectBtn = document.getElementById('connectBtn')
    const disconnectBtn = document.getElementById('disconnectBtn')
    const transcriptEl = document.getElementById('transcript')
    const roomNameEl = document.getElementById('roomName')
    const agentStatusEl = document.getElementById('agentStatus')
    const visualizerBars = document.querySelectorAll('.bar')

    // Generate a simple token (for demo purposes)
    // In production, get token from your backend
    async function generateToken() {
      const roomName = 'travel-room-' + Math.random().toString(36).substring(7)
      const identity = 'user-' + Math.random().toString(36).substring(7)
      
      // For demo, we'll connect without token validation
      // In production, use AccessToken from livekit-server-sdk
      return { roomName, identity, token: null }
    }

    async function connect() {
      try {
        updateStatus('connecting', 'üü° Connecting...')
        connectBtn.disabled = true

        const { roomName, identity } = await generateToken()

        // Create room
        room = new LivekitClient.Room({
          adaptiveStream: true,
          dynacast: true,
        })

        // Set up event listeners
        room
          .on(LivekitClient.RoomEvent.Connected, () => {
            console.log('‚úÖ Connected to room')
            updateStatus('connected', 'üü¢ Connected - Speak now!')
            roomNameEl.textContent = roomName
            agentStatusEl.textContent = 'Waiting for Alex to join...'
            startVisualizer()
          })
          .on(LivekitClient.RoomEvent.Disconnected, () => {
            console.log('‚ùå Disconnected from room')
            updateStatus('disconnected', '‚ö´ Disconnected')
            stopVisualizer()
            cleanup()
          })
          .on(LivekitClient.RoomEvent.ParticipantConnected, (participant) => {
            console.log('üë§ Participant joined:', participant.identity)
            if (participant.identity.includes('agent') || participant.identity.includes('alex')) {
              agentStatusEl.textContent = '‚úÖ Alex joined!'
              addTranscript('system', 'Alex has joined the conversation')
            }
          })
          .on(LivekitClient.RoomEvent.TrackSubscribed, (track, publication, participant) => {
            console.log('üéµ Track subscribed:', track.kind, 'from', participant.identity)
            
            if (track.kind === LivekitClient.Track.Kind.Audio) {
              const audioElement = track.attach()
              document.getElementById('audioOutput').replaceWith(audioElement)
              audioElement.id = 'audioOutput'
              audioElement.autoplay = true
              console.log('üîä Audio track attached')
            }
          })
          .on(LivekitClient.RoomEvent.DataReceived, (payload, participant) => {
            const decoder = new TextDecoder()
            const message = decoder.decode(payload)
            console.log('üì® Data received:', message)
            try {
              const data = JSON.parse(message)
              if (data.transcript) {
                addTranscript('agent', data.transcript)
              }
            } catch (e) {
              console.log('Not JSON data')
            }
          })

        // Connect to room with API key (simplified for demo)
        await room.connect(LIVEKIT_URL, `${LIVEKIT_API_KEY}:${LIVEKIT_API_SECRET}`, {
          autoSubscribe: true,
        })

        // Publish microphone
        localTrack = await LivekitClient.createLocalAudioTrack()
        await room.localParticipant.publishTrack(localTrack)
        console.log('üé§ Microphone published')

        connectBtn.disabled = true
        disconnectBtn.disabled = false

        addTranscript('system', 'Connected! Alex will greet you shortly...')

      } catch (error) {
        console.error('‚ùå Connection error:', error)
        updateStatus('disconnected', '‚ùå Connection failed: ' + error.message)
        connectBtn.disabled = false
      }
    }

    async function disconnect() {
      if (room) {
        await room.disconnect()
      }
      cleanup()
    }

    function cleanup() {
      if (localTrack) {
        localTrack.stop()
        localTrack = null
      }
      room = null
      connectBtn.disabled = false
      disconnectBtn.disabled = true
      stopVisualizer()
      roomNameEl.textContent = '-'
      agentStatusEl.textContent = '-'
    }

    function updateStatus(state, text) {
      statusEl.className = 'status ' + state
      statusEl.textContent = text
    }

    function addTranscript(speaker, text) {
      const item = document.createElement('div')
      item.className = 'transcript-item ' + speaker
      
      const label = document.createElement('div')
      label.className = 'transcript-label'
      label.textContent = speaker === 'agent' ? 'ü§ñ Alex' : speaker === 'user' ? 'üë§ You' : 'üí¨ System'
      
      const content = document.createElement('div')
      content.textContent = text
      
      item.appendChild(label)
      item.appendChild(content)
      
      if (transcriptEl.firstChild.style) {
        // Remove placeholder
        transcriptEl.innerHTML = ''
      }
      
      transcriptEl.appendChild(item)
      transcriptEl.scrollTop = transcriptEl.scrollHeight
      
      transcript.push({ speaker, text, time: new Date() })
    }

    let visualizerInterval = null
    function startVisualizer() {
      visualizerInterval = setInterval(() => {
        visualizerBars.forEach((bar, index) => {
          if (Math.random() > 0.5) {
            bar.classList.add('active')
          } else {
            bar.classList.remove('active')
          }
        })
      }, 200)
    }

    function stopVisualizer() {
      if (visualizerInterval) {
        clearInterval(visualizerInterval)
        visualizerInterval = null
      }
      visualizerBars.forEach(bar => bar.classList.remove('active'))
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (room) {
        room.disconnect()
      }
    })

    console.log('‚úÖ LiveKit Frontend loaded')
    console.log('üéôÔ∏è Alex Travel Assistant ready')
    console.log('üì° LiveKit URL:', LIVEKIT_URL)
  </script>
</body>
</html>


