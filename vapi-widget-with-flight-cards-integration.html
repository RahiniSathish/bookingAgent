<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attar Travel - Vapi Widget with Flight Cards</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 800px;
            height: 90vh;
            background: #0f0f1e;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .header p {
            font-size: 12px;
            opacity: 0.95;
        }

        .widget-wrapper {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        vapi-widget {
            flex: 1;
            width: 100%;
        }

        /* Flight Cards Styling - For Injection Inside Widget */
        .flight-card-message {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 1px solid #2a2a3e;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
            margin: 12px 0;
        }

        .flight-card-message:hover {
            border-color: #667eea;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.2);
            transform: translateY(-4px);
        }

        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px;
        }

        .route-display {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 8px;
        }

        .airport-code {
            font-size: 24px;
            font-weight: 700;
            text-align: center;
        }

        .airport-time {
            font-size: 11px;
            opacity: 0.95;
            text-align: center;
        }

        .route-arrow {
            font-size: 18px;
            opacity: 0.95;
        }

        .card-meta {
            font-size: 11px;
            display: flex;
            justify-content: space-between;
            gap: 8px;
            opacity: 0.9;
        }

        .card-body {
            padding: 12px;
            background: #0f0f1e;
        }

        .flight-info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 10px;
        }

        .info-item {
            text-align: center;
        }

        .info-label {
            font-size: 9px;
            color: #8b8b8b;
            text-transform: uppercase;
            margin-bottom: 3px;
        }

        .info-value {
            font-size: 13px;
            color: #14B8A6;
            font-weight: 600;
        }

        .card-footer {
            display: flex;
            gap: 10px;
            padding: 10px;
            background: #1a1a2e;
            border-top: 1px solid #2a2a3e;
        }

        .price-display {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .price-label {
            font-size: 9px;
            color: #8b8b8b;
        }

        .price {
            font-size: 16px;
            color: #14B8A6;
            font-weight: 700;
        }

        .book-btn {
            background: linear-gradient(135deg, #14B8A6 0%, #0891b2 100%);
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 11px;
            transition: all 0.3s ease;
        }

        .book-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(20, 184, 166, 0.4);
        }

        .location-badge {
            display: inline-block;
            background: rgba(20, 184, 166, 0.1);
            color: #14B8A6;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 10px;
            margin: 3px 2px 0 0;
            border: 1px solid #14B8A6;
        }

        .hotel-link {
            display: inline-block;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding: 6px 10px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 11px;
            margin-top: 6px;
            border: 1px solid #667eea;
            transition: all 0.3s ease;
        }

        .hotel-link:hover {
            background: rgba(102, 126, 234, 0.2);
            transform: translateX(2px);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚úàÔ∏è Attar Travel - Flight Search</h1>
            <p>Voice-activated flight search with real-time cards inside chat</p>
        </div>

        <div class="widget-wrapper">
            <vapi-widget
                public-key="577ae6b3-53b9-4a37-b6f6-74e8e8808368"
                assistant-id="e1c04a87-a8cf-4438-a91b-5888f69d1ef2"
                mode="voice"
                theme="dark"
                base-bg-color="#1a1a2e"
                accent-color="#14B8A6"
                cta-button-color="#667eea"
                cta-button-text-color="#ffffff"
                border-radius="large"
                size="full"
                position="center"
                title="üé§ Flight Search"
                start-button-text="üé§ Start Voice"
                end-button-text="End Call"
                chat-first-message="Hey! üëã Welcome to Attar Travel. I'm Alex, your AI assistant. How can I help? Try: 'Show flights from Bangalore to Jeddah'"
                chat-placeholder="Type message..."
                show-transcript="true"
                enable-chat="true"
                consent-required="false"
                krisp-enabled="false"
            ></vapi-widget>
        </div>
    </div>

    <script src="https://unpkg.com/@vapi-ai/client-sdk-react/dist/embed/widget.umd.js" async type="text/javascript"></script>

    <script>
        const BACKEND_URL = 'http://localhost:4000';
        const mockFlights = [
            {
                origin: 'BLR',
                destination: 'JED',
                airline: 'Emirates',
                flight_number: 'EK 501',
                departure_time: '02:15',
                arrival_time: '05:30',
                duration: '3h 15m',
                price: 28450,
                stops: 0,
                cabin_class: 'Economy',
                gate: '12',
                seat: '4D',
                origin_city: 'Bangalore',
                destination_city: 'Jeddah'
            },
            {
                origin: 'BLR',
                destination: 'JED',
                airline: 'Air India',
                flight_number: 'AI 965',
                departure_time: '22:30',
                arrival_time: '01:15',
                duration: '5h 45m',
                price: 32150,
                stops: 1,
                cabin_class: 'Business',
                gate: '8',
                seat: '2A',
                origin_city: 'Bangalore',
                destination_city: 'Jeddah'
            }
        ];

        let currentFlights = [];

        function getVapiWidget() {
            return document.querySelector('vapi-widget');
        }

        function setupVapiListener() {
            const widget = getVapiWidget();
            if (!widget) {
                setTimeout(setupVapiListener, 1000);
                return;
            }

            widget.addEventListener('vapi:transcript', (event) => {
                const transcript = event.detail?.transcript || '';
                console.log('üìù Transcript:', transcript);
                processUserQuery(transcript);
            });

            console.log('‚úÖ Vapi listener setup complete');
        }

        function processUserQuery(text) {
            const textLower = text.toLowerCase();
            
            if (!textLower.includes('flight') && !textLower.includes('search') && !textLower.includes('show')) {
                return;
            }

            const params = extractFlightParams(text);
            
            if (params.origin && params.destination) {
                console.log('üîç Searching flights:', params);
                searchFlights(params);
            }
        }

        function extractFlightParams(text) {
            const cityMap = {
                'bangalore': 'BLR', 'bengaluru': 'BLR',
                'jeddah': 'JED', 'riyadh': 'RUH', 'dubai': 'DXB',
                'mumbai': 'BOM', 'delhi': 'DEL', 'hyderabad': 'HYD'
            };

            const textLower = text.toLowerCase();
            let origin = null, destination = null;

            for (let [city, code] of Object.entries(cityMap)) {
                if (textLower.includes(city)) {
                    if (!origin) origin = code;
                    else if (!destination) destination = code;
                }
            }

            return {
                origin,
                destination,
                departure_date: new Date().toISOString().split('T')[0]
            };
        }

        async function searchFlights(params) {
            try {
                console.log('üöÄ Calling backend API...');
                
                const response = await fetch(`${BACKEND_URL}/api/search-flights`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params)
                });

                const data = await response.json();
                
                if (data.success && data.flights && data.flights.length > 0) {
                    console.log(`‚úÖ Found ${data.flights.length} flights`);
                    currentFlights = data.flights;
                    injectFlightCardsIntoWidget(data.flights);
                } else {
                    currentFlights = mockFlights;
                    console.log('Using mock flights');
                    injectFlightCardsIntoWidget(mockFlights);
                }
            } catch (error) {
                console.error('‚ùå Search error:', error);
                currentFlights = mockFlights;
                injectFlightCardsIntoWidget(mockFlights);
            }
        }

        function injectFlightCardsIntoWidget(flights) {
            const widget = getVapiWidget();
            if (!widget) {
                console.log('Widget not found yet');
                setTimeout(() => injectFlightCardsIntoWidget(flights), 500);
                return;
            }

            // Create a container for flight cards
            let cardsContainer = document.querySelector('#flight-cards-injection');
            
            if (!cardsContainer) {
                cardsContainer = document.createElement('div');
                cardsContainer.id = 'flight-cards-injection';
                cardsContainer.style.cssText = `
                    position: fixed;
                    bottom: 120px;
                    right: 20px;
                    width: 350px;
                    max-height: 400px;
                    overflow-y: auto;
                    z-index: 9999;
                    pointer-events: auto;
                `;
                document.body.appendChild(cardsContainer);
            }

            // Clear previous cards
            cardsContainer.innerHTML = '';

            // Add cards
            flights.slice(0, 3).forEach(flight => {
                const cardHTML = createFlightCard(flight);
                cardsContainer.appendChild(cardHTML);
            });

            console.log('‚úÖ Flight cards injected into widget');
        }

        function createFlightCard(flight) {
            const price = flight.price ? `‚Çπ${Number(flight.price).toLocaleString()}` : 'N/A';
            const stops = flight.stops === 0 ? 'Non-stop' : `${flight.stops} stop(s)`;

            const card = document.createElement('div');
            card.className = 'flight-card-message';
            card.innerHTML = `
                <div class="card-header">
                    <div class="route-display">
                        <div>
                            <div class="airport-code">${flight.origin}</div>
                            <div class="airport-time">${flight.departure_time}</div>
                        </div>
                        <div class="route-arrow">‚Üí</div>
                        <div>
                            <div class="airport-code">${flight.destination}</div>
                            <div class="airport-time">${flight.arrival_time}</div>
                        </div>
                    </div>
                    <div class="card-meta">
                        <span>${flight.airline} ${flight.flight_number}</span>
                        <span>${stops}</span>
                    </div>
                </div>

                <div class="card-body">
                    <div class="flight-info-grid">
                        <div class="info-item">
                            <div class="info-label">Duration</div>
                            <div class="info-value">${flight.duration}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Class</div>
                            <div class="info-value">${flight.cabin_class || 'Economy'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Gate</div>
                            <div class="info-value">${flight.gate || 'TBD'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Seat</div>
                            <div class="info-value">${flight.seat || 'TBD'}</div>
                        </div>
                    </div>

                    <div>
                        <span class="location-badge">üìç ${flight.origin_city || flight.origin}</span>
                        <span class="location-badge">üìç ${flight.destination_city || flight.destination}</span>
                    </div>

                    <a href="https://www.google.com/maps/search/hotels+in+${flight.destination_city || flight.destination}" 
                       target="_blank" class="hotel-link">
                        üè® Find Hotels
                    </a>
                </div>

                <div class="card-footer">
                    <div class="price-display">
                        <div class="price-label">Price</div>
                        <div class="price">${price}</div>
                    </div>
                    <button class="book-btn" onclick="alert('Booking flight ${flight.flight_number}')">
                        ‚úàÔ∏è Book
                    </button>
                </div>
            `;

            return card;
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Initializing Vapi flight cards...');
            setupVapiListener();
        });

        setTimeout(setupVapiListener, 2000);
    </script>
</body>
</html>
