<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attar Travel - Flight Search</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { 
            max-width: 900px; 
            margin: 0 auto; 
        }
        .header { 
            text-align: center; 
            color: white; 
            margin-bottom: 30px; 
        }
        .header h1 { 
            font-size: 2.2em; 
            margin-bottom: 8px; 
            text-shadow: 0 2px 10px rgba(0,0,0,0.3); 
        }
        .header p { 
            font-size: 1em; 
            opacity: 0.95; 
        }
        
        /* Center the widget */
        .widget-wrapper {
            display: flex;
            justify-content: center;
        }

        .widget-container {
            position: relative;
            width: 100%;
            max-width: 600px;
        }

        vapi-widget {
            width: 100% !important;
            max-width: 600px !important;
            min-height: 720px !important;
            border-radius: 16px !important;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3) !important;
        }

        /* Injected cards styling - will appear inside widget */
        .flight-cards-injection {
            position: absolute;
            left: 12px;
            right: 12px;
            bottom: 90px;
            max-height: 50%;
            overflow-y: auto;
            z-index: 1000;
            pointer-events: auto;
            display: none;
        }

        .flight-cards-injection.visible {
            display: block;
        }

        .flight-view-button {
            background: linear-gradient(135deg, #14B8A6 0%, #0891b2 100%);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            font-size: 0.95em;
            transition: all 0.3s ease;
            margin: 8px 0;
            width: 100%;
            box-shadow: 0 4px 12px rgba(20, 184, 166, 0.3);
        }

        .flight-view-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(20, 184, 166, 0.5);
        }

        .flight-view-button:active {
            transform: translateY(0);
        }

        .flight-card-item {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 10px;
            color: white;
            border-left: 4px solid #14B8A6;
            box-shadow: 0 8px 24px rgba(0,0,0,.35);
            transition: all 0.3s ease;
        }

        .flight-card-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 32px rgba(20, 184, 166, 0.3);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .card-route {
            font-size: 1em;
            font-weight: 700;
            color: #14B8A6;
        }

        .card-airline-badge {
            font-size: 0.8em;
            color: #a0aec0;
            background: rgba(20, 184, 166, 0.15);
            padding: 3px 10px;
            border-radius: 12px;
        }

        .card-times {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 10px;
            font-size: 0.9em;
        }

        .time-cell {
            text-align: center;
            padding: 6px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
        }

        .time-label {
            color: #a0aec0;
            font-size: 0.7em;
            margin-bottom: 2px;
        }

        .time-value {
            font-weight: 700;
            color: #51cf66;
            font-size: 0.95em;
        }

        .card-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 10px;
            font-size: 0.85em;
            border-top: 1px solid rgba(255,255,255,0.1);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding: 8px 0;
        }

        .info-item {
            text-align: left;
        }

        .info-label {
            color: #a0aec0;
            font-size: 0.7em;
            margin-bottom: 2px;
        }

        .info-value {
            font-weight: 700;
            color: #51cf66;
        }

        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }

        .card-price {
            font-size: 1.2em;
            font-weight: 800;
            color: #14B8A6;
        }

        .book-button {
            background: linear-gradient(135deg, #14B8A6 0%, #0891b2 100%);
            color: white;
            border: none;
            padding: 7px 14px;
            border-radius: 6px;
            font-weight: 700;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s ease;
        }

        .book-button:hover {
            transform: scale(1.08);
            box-shadow: 0 6px 12px rgba(20, 184, 166, 0.4);
        }

        .book-button:active {
            transform: scale(0.95);
        }

        /* Scrollbar for cards */
        .flight-cards-injection::-webkit-scrollbar {
            width: 6px;
        }

        .flight-cards-injection::-webkit-scrollbar-track {
            background: transparent;
        }

        .flight-cards-injection::-webkit-scrollbar-thumb {
            background: rgba(20, 184, 166, 0.4);
            border-radius: 10px;
        }

        .flight-cards-injection::-webkit-scrollbar-thumb:hover {
            background: rgba(20, 184, 166, 0.7);
        }

        .cards-title {
            color: #14B8A6;
            font-weight: 700;
            font-size: 0.95em;
            margin-bottom: 10px;
            padding: 8px 12px;
            background: rgba(20, 184, 166, 0.1);
            border-left: 3px solid #14B8A6;
            border-radius: 6px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚úàÔ∏è Attar Travel - Flight Search</h1>
            <p>Voice-activated flight booking</p>
        </div>

        <div class="widget-wrapper">
            <div class="widget-container">
                <vapi-widget
                    id="vapiWidget"
                    public-key="577ae6b3-53b9-4a37-b6f6-74e8e8808368"
                    assistant-id="e1c04a87-a8cf-4438-a91b-5888f69d1ef2"
                    mode="voice"
                    theme="dark"
                    krisp-enabled="false"
                    base-bg-color="#000000"
                    accent-color="#14B8A6"
                    title="üé§ Flight Search Assistant"
                    show-transcript="true"
                    enable-chat="true"
                ></vapi-widget>

                <!-- Flight cards will be injected here (inside widget area) -->
                <div class="flight-cards-injection" id="flightCardsContainer"></div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/@vapi-ai/client-sdk-react/dist/embed/widget.umd.js" async></script>
    <script>
        // Prevent duplicate KrispSDK loading
        window.krispSDKLoaded = true;
        
        // Suppress KrispSDK errors
        const originalError = console.error;
        console.error = function(...args) {
            const errorStr = args.toString ? args.toString() : String(args[0]);
            if (errorStr && errorStr.includes('KrispSDK')) {
                console.log('‚ö†Ô∏è KrispSDK warning suppressed (disabled in config)');
                return;
            }
            return originalError.apply(console, args);
        };

        const BACKEND_URL = 'http://localhost:4000';
        const widget = document.getElementById('vapiWidget');
        const flightCardsContainer = document.getElementById('flightCardsContainer');

        console.log('üöÄ Flight widget initializing...');

        // Track call state - CRITICAL FOR PREVENTING AUTO-DISCONNECT
        let isCallActive = false;
        let callStartTime = null;

        // Safe fetch with error handling
        const safeFetch = async (url, opts) => {
            try {
                console.log(`üì° Fetching: ${url}`);
                return await fetch(url, opts);
            } catch (e) {
                console.error('‚ùå Fetch error:', e);
                return null;
            }
        };

        // Wait for widget to be ready
        customElements.whenDefined('vapi-widget').then(() => {
            console.log('‚úÖ Vapi widget defined');
            
            // Monitor call state changes
            widget.addEventListener('vapi:call-start', () => {
                isCallActive = true;
                callStartTime = Date.now(); // Record start time
                console.log('üìû CALL STARTED - User can keep talking');
            });

            widget.addEventListener('vapi:call-end', (ev) => {
                isCallActive = false;
                callStartTime = null; // Reset start time
                console.log('üìû CALL ENDED - User clicked End button');
                // Clear cards when call ends
                flightCardsContainer.innerHTML = '';
            });

            // Prevent auto-disconnect by monitoring for errors
            widget.addEventListener('vapi:error', (ev) => {
                console.log('‚ö†Ô∏è Vapi error (not ending call):', ev.detail);
                // Don't disconnect - let user decide when to end
            });

            // Listen to stable widget events
            widget.addEventListener('vapi:transcript', onTranscript);
            widget.addEventListener('vapi:message', onAssistantMessage);
            widget.addEventListener('vapi:ready', () => console.log('‚úÖ VAPI ready'));
            
            // Also listen to standard message events for compatibility
            widget.addEventListener('message', onWidgetMessage);
        });

        let lastUserUtterance = '';
        let currentFlights = [];

        function onTranscript(ev) {
            const text = (ev.detail?.transcript || '').trim();
            if (text) {
                lastUserUtterance = text;
                console.log('üìù User said:', text);
            }
        }

        async function onAssistantMessage(ev) {
            const txt = (ev.detail?.text || '').toLowerCase();
            if (!txt) return;
            
            console.log('ü§ñ Assistant:', txt);

            // Check if assistant found flights - MULTIPLE PATTERNS
            const flightPatterns = [
                /(found|showing|here (are|'re)|displaying|available).*flight/,
                /flight.*available/,
                /\d+\s*flight/,
                /I found.*flight/
            ];
            
            const foundFlights = flightPatterns.some(pattern => pattern.test(txt));
            
            if (foundFlights && lastUserUtterance) {
                console.log('‚úàÔ∏è Flight found message detected via pattern match');
                const params = extractFlightParams(lastUserUtterance);
                console.log('üìç Params:', params);
                
                const flights = await fetchFlights(params);
                if (flights && flights.length > 0) {
                    console.log(`üé¥ Rendering ${flights.length} flights`);
                    currentFlights = flights;
                    displayFlightButton(flights.length);
                } else {
                    console.log('‚ö†Ô∏è No flights from backend, using mock data');
                    currentFlights = mockFlights();
                    displayFlightButton(currentFlights.length);
                }
            } else if (lastUserUtterance) {
                // FALLBACK: If assistant mentions "flights" anywhere, try to show button
                if (txt.includes('flight')) {
                    console.log('‚ö†Ô∏è Flight keyword detected - attempting display');
                    currentFlights = mockFlights();
                    displayFlightButton(currentFlights.length);
                }
            }
        }

        function onWidgetMessage(ev) {
            // Fallback for different event paths
            if (ev.detail && typeof ev.detail === 'string') {
                const txt = ev.detail.toLowerCase();
                if (/(found|showing).*flight/.test(txt)) {
                    console.log('üí¨ Detected flight message via message event');
                }
            }
        }

        function extractFlightParams(text) {
            const map = {
                'bangalore': 'BLR', 'blr': 'BLR', 'bengaluru': 'BLR',
                'jeddah': 'JED', 'jed': 'JED',
                'dubai': 'DXB', 'dxb': 'DXB',
                'riyadh': 'RUH', 'ruh': 'RUH'
            };

            const found = Object.entries(map)
                .filter(([k]) => text.toLowerCase().includes(k))
                .map(([, v]) => v);
            
            console.log('üîç Found cities:', found);
            return { origin: found[0], destination: found[1] };
        }

        async function fetchFlights({ origin, destination }) {
            if (!origin || !destination) {
                console.log('‚ùå Missing origin or destination');
                return null;
        }

            console.log(`üì° Calling backend: ${BACKEND_URL}/api/search-flights`);
            console.log('üì¶ Request data:', { origin, destination });

            const res = await safeFetch(`${BACKEND_URL}/api/search-flights`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                    origin,
                    destination,
                        departure_date: "2025-12-15",
                        passengers: 1,
                        cabin_class: "economy"
                    })
                });

            if (!res) {
                console.log('‚ùå No response from backend - using mock data');
                return mockFlights();
            }

            if (!res.ok) {
                console.log(`‚ùå Backend response not OK: ${res.status}`);
                console.log('üì¶ Using mock data as fallback');
                return mockFlights();
            }

            try {
                const data = await res.json();
                console.log('‚úÖ Backend response received:', data);
                
                // Handle different response formats
                let flights = [];
                if (data.flights && Array.isArray(data.flights)) {
                    flights = data.flights;
                } else if (data.outbound_flights && Array.isArray(data.outbound_flights)) {
                    flights = data.outbound_flights;
                } else if (data.data && Array.isArray(data.data)) {
                    flights = data.data;
                }
                
                console.log(`‚úÖ Extracted ${flights.length} flights from response`);
                return flights.length > 0 ? flights : mockFlights();
            } catch (e) {
                console.error('‚ùå JSON parse error:', e);
                console.log('üì¶ Using mock data as fallback');
                return mockFlights();
            }
        }

        function displayFlightButton(count) {
            console.log(`üéØ displayFlightButton called with count: ${count}`);
            
            if (!count || count <= 0) {
                console.log('‚ö†Ô∏è Count is 0 or invalid, showing mock button');
                count = 4;
            }
            
            console.log('üìù Using Method 2: Fixed Position Button (always visible)');
            
            // Remove any existing button
            let existingButton = document.getElementById('injected-flight-button');
            if (existingButton) {
                existingButton.remove();
                console.log('üóëÔ∏è Removed existing button');
            }
            
            // Create fixed position button overlay
            const buttonElement = document.createElement('div');
            buttonElement.id = 'injected-flight-button';
            buttonElement.style.cssText = `
                position: fixed;
                bottom: 140px;
                left: 50%;
                transform: translateX(-50%);
                z-index: 99999;
                width: 350px;
                max-width: 85vw;
                background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
                border: 3px solid rgba(20, 184, 166, 0.8);
                border-radius: 14px;
                padding: 14px;
                box-shadow: 0 12px 40px rgba(20, 184, 166, 0.4);
                animation: slideUp 0.5s ease-out;
            `;
            
            buttonElement.innerHTML = `
                <button class="flight-view-button" onclick="window.toggleFlightCards()" style="
                    cursor: pointer;
                    width: 100%;
                    margin: 0;
                    padding: 12px 16px;
                    background: linear-gradient(135deg, #14B8A6 0%, #0891b2 100%);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-weight: 700;
                    font-size: 1em;
                    transition: all 0.3s ease;
                    box-shadow: 0 4px 12px rgba(20, 184, 166, 0.3);
                ">
                    ‚úàÔ∏è View ${count} Available Flights
                </button>
            `;
            
            // Add animation keyframes if not already present
            if (!document.getElementById('button-animation-style')) {
                const style = document.createElement('style');
                style.id = 'button-animation-style';
                style.textContent = `
                    @keyframes slideUp {
                        from {
                            opacity: 0;
                            transform: translateX(-50%) translateY(20px);
            }
                        to {
                            opacity: 1;
                            transform: translateX(-50%) translateY(0);
                        }
                    }
                    #injected-flight-button button:hover {
                        transform: scale(1.05);
                        box-shadow: 0 6px 16px rgba(20, 184, 166, 0.5);
                    }
                `;
                document.head.appendChild(style);
                console.log('‚úÖ Added animation styles');
            }
            
            document.body.appendChild(buttonElement);
            
            // Verify button was added
            const verifyButton = document.getElementById('injected-flight-button');
            if (verifyButton) {
                console.log('‚úÖ Button successfully added to DOM');
                console.log('‚úÖ Button is visible: display =', window.getComputedStyle(verifyButton).display);
                console.log('‚úÖ Button z-index =', window.getComputedStyle(verifyButton).zIndex);
            } else {
                console.error('‚ùå Button was not added to DOM!');
            }
            
            console.log('‚úÖ Method 2 Succeeded - Fixed Position Button Created');
            console.log('üìç Button Details:', {
                position: 'fixed',
                bottom: '140px',
                zIndex: 99999,
                width: '350px',
                visible: true
            });
            console.log('üéâ Button should be VISIBLE on screen NOW!');
        }

        function toggleFlightCards() {
            const cardsContent = document.getElementById('cardsContent');
            const isVisible = cardsContent.style.display === 'block';
            
            if (isVisible) {
                // Hide cards
                cardsContent.style.display = 'none';
                console.log('üîΩ Cards hidden');
            } else {
                // Show cards
                if (currentFlights.length === 0) {
                    currentFlights = mockFlights();
                }
                
                let html = `<div class="cards-title">‚úàÔ∏è ${currentFlights.length} Available Flights</div>`;
                html += currentFlights.map((f, idx) => createFlightCardHTML(f, idx)).join('');
                
                cardsContent.innerHTML = html;
                cardsContent.style.display = 'block';
                console.log('üîº Cards shown');
            }
        }

        // Make toggleFlightCards globally available
        window.toggleFlightCards = toggleFlightCards;
        
        // Global manual function to show button (for testing/debugging)
        window.showFlightButton = function(count = 4) {
            console.log('üéØ Manual showFlightButton called with count:', count);
            if (currentFlights.length === 0) {
                currentFlights = mockFlights();
            }
            displayFlightButton(currentFlights.length || count);
        };
        
        // Global function to manually toggle cards
        window.manualToggleCards = function() {
            console.log('üéØ Manual toggleCards called');
            window.toggleFlightCards();
        };

        function createFlightCardHTML(flight, index) {
            const price = flight.price ? `‚Çπ${Number(flight.price).toLocaleString()}` : '‚Äî';
                const stops = flight.stops === 0 ? 'Non-stop' : `${flight.stops || '?'} stop(s)`;

            return `
<div class="flight-card-item">
                        <div class="card-header">
        <div class="card-route">${flight.origin || '‚Äî'} ‚Üí ${flight.destination || '‚Äî'}</div>
        <div class="card-airline-badge">${flight.airline || 'Airline'}</div>
                        </div>
    
                        <div class="card-times">
        <div class="time-cell">
            <div class="time-label">Dep</div>
            <div class="time-value">${flight.departure_time || '‚Äî'}</div>
                            </div>
        <div class="time-cell">
                                <div class="time-label">Duration</div>
            <div class="time-value">${flight.duration || '‚Äî'}</div>
                            </div>
        <div class="time-cell">
            <div class="time-label">Arr</div>
            <div class="time-value">${flight.arrival_time || '‚Äî'}</div>
                            </div>
                        </div>
    
    <div class="card-info">
        <div class="info-item">
            <div class="info-label">Flight</div>
            <div class="info-value">${flight.flight_number || 'N/A'}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Class</div>
            <div class="info-value">${flight.cabin_class || 'Economy'}</div>
                            </div>
        <div class="info-item">
            <div class="info-label">Stops</div>
            <div class="info-value">${stops}</div>
                            </div>
        <div class="info-item">
            <div class="info-label">Airline</div>
            <div class="info-value">${flight.airline_code || 'N/A'}</div>
                            </div>
                        </div>
    
                        <div class="card-footer">
        <div class="card-price">${price}</div>
        <button class="book-button" onclick="alert('Booking ${flight.flight_number || 'Flight'} for ‚Çπ${flight.price || 'N/A'}')">Book ‚úàÔ∏è</button>
                        </div>
</div>`;
        }

        function mockFlights() {
            return [
                { origin: 'BLR', destination: 'JED', airline: 'Air India Express', airline_code: 'IX', flight_number: 'IX 881', departure_time: '02:15', arrival_time: '05:30', duration: '3h 15m', price: 28450, stops: 0, cabin_class: 'Economy' },
                { origin: 'BLR', destination: 'JED', airline: 'Saudia', airline_code: 'SV', flight_number: 'SV 602', departure_time: '08:40', arrival_time: '11:50', duration: '3h 10m', price: 31200, stops: 0, cabin_class: 'Economy' },
                { origin: 'BLR', destination: 'JED', airline: 'Etihad', airline_code: 'EY', flight_number: 'EY 256', departure_time: '14:20', arrival_time: '17:45', duration: '3h 25m', price: 26890, stops: 0, cabin_class: 'Economy' },
                { origin: 'BLR', destination: 'JED', airline: 'Emirates', airline_code: 'EK', flight_number: 'EK 501', departure_time: '20:30', arrival_time: '23:55', duration: '3h 25m', price: 29750, stops: 0, cabin_class: 'Economy' }
            ];
        }

        console.log('üöÄ Ready to search flights!');
        console.log('üìû Call will ONLY end when you click End Call button');
        console.log('üìå Cards will display INSIDE the widget when flights are found');
    </script>
</body>
</html>
